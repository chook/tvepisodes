<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs scrolling="true" title="My Episodes Gadget" height="250" >
    <Require feature="tabs" />
    <Require feature="minimessage" />
  </ModulePrefs>
  <Content type="html" view="home,canvas">
    <![CDATA[
  <html>
<head>
    <style type="text/css">
		@import "http://tvepisodes.googlecode.com/svn/trunk/client/myEpisodesCss.css";
    </style>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" >
     //global variables
	 var checked_no=0;
	 var data = null;
	 var table = null;
	 var query = null;
	 var userID = 11111;
	 
	google.load("visualization", "1", {packages:["columnchart", "table" ,"barchart" , "piechart"]});	 
    function init() {
        // Initialize tabs.
         var tabs = new _IG_Tabs(__MODULE_ID__ );
        // When you use addDynamicTab, the tab's content is 
        // dynamically generated through the callback function. 
        tabs.addTab("News", "news_div", create_msg());
        tabs.addTab("My Shows", "epsd_div", getFavorites);
        tabs.addTab("Add", "add_div");
        tabs.addTab("Statistics", "sts_div", UnTip);
       }
    function search_episode()    {
		UnTip();
		document.getElementById('no_result_div').style.display='none';
		document.getElementById('vis_results').style.display = 'none' ;
		document.getElementById('most_pop').style.display = 'none';
		document.getElementById('reset_srch_btn').disabled = false;	
		document.getElementById('searching...').style.display = '' ;
		checked_no = 0;
		var url = 'http://epihourtesting.appspot.com/SearchShow?ShowName=' + document.getElementById('srch_txt').value.toLowerCase();
		//alert(url);
		query = new google.visualization.Query(url);
		///alert("after query");
		// Send the query with a callback function.
		query.send(handleQueryResponse);
		//alert("after sending");
		document.getElementById('most_pop').style.display = 'none';
		document.getElementById('searching...').style.display = '' ;
		document.getElementById('reset_srch_btn').disabled = false;		
	}
  
	function handleQueryResponse(response)	{
		if (response.isError()) {
			alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
			return;
		}
		data = response.getDataTable();
		data.addColumn('string' , '');
		for (var j=0; j<data.getNumberOfRows(); j++){
			data.setValue(j , 6, '<input type="submit" align="center"  class="btn" value="Add" id="add'+j+'" onmouseover="this.className=\'btnhov\'" onmouseout="this.className=\'btn\'" onclick="add_show(\'data.getValue('+j+',0)\')" />');
		}
		table = new google.visualization.Table(document.getElementById('vis_results'));
		var view = new google.visualization.DataView(data);
		view.hideColumns([0,2,3,4,5]); // show only the show name and the add buttons.
		if (data.getNumberOfRows()<1){
			document.getElementById('vis_results').style.display='none';
			document.getElementById('searching...').style.display = 'none' ;
			document.getElementById('no_result_div').style.display='';
		}
		else{
			document.getElementById('vis_results').style.display = '' ;
			document.getElementById('searching...').style.display = 'none' ;
			table.draw(view, {showRowNumber: true, allowHtml:true, width: 210, page: 'enable', pageSize: 5});
			google.visualization.events.addListener(table, 'select', selectHandler);
			function selectHandler() {
				var selection = table.getSelection();
				if (selection.length>0){
					for (var i = 0; i < selection.length; i++) {
						var name = data.getValue(selection[i].row, 1);
						var date = data.getValue(selection[i].row, 2);
						var seasonsNum = data.getValue(selection[i].row, 3);
						var country = data.getValue(selection[i].row, 4);
						var infoLink =  data.getValue(selection[i].row, 5);
						if (seasonsNum != 1)
							Tip('\"'+name+ '\" was first broadcasted on '+date+'. There are '+seasonsNum+' seasons for this show and it\'s original country is '+country+'.<br>For more information please visit <a href='+infoLink+' target=\'_blank\'>'+infoLink+'</a>' , TITLE, '<div class=\'TitleCls\'>'+name+'</div>', STICKY, true, CLOSEBTN , true,CENTERMOUSE, true, ABOVE, false , FADEIN, 500, FADEOUT, 500);
						else
							Tip('\"'+name+ '\" was first broadcasted on '+date+'. There is '+seasonsNum+' season for this show and it\'s original country is '+country+'.<br>For more information please visit <a href='+infoLink+' target=\'_blank\'>'+infoLink+'</a>' , TITLE, '<div class=\'TitleCls\'>'+name+'</div>' , STICKY, true, CLOSEBTN , true ,CENTERMOUSE, true , ABOVE , false , FADEIN, 500, FADEOUT, 500);
					}
				}
				else {
					UnTip();
				}
			}
		}
	}
	
    function reset_srch_text() 
      {
        if (document.getElementById('srch_txt').value == 'TV Show Name Here')
            document.getElementById('srch_txt').value = '';
      }
    function reset_srch() 
      { 
        checked_no=0;
		UnTip();
        //document.getElementById('add_btn').disabled = true;
        document.getElementById('reset_srch_btn').disabled = true;
        document.getElementById('srch_txt').value = 'TV Show Name Here';
        document.getElementById('most_pop').style.display = ''; 
		document.getElementById('vis_results').style.display = 'none'; 
        document.getElementById('no_result_div').style.display = 'none' ;
		document.getElementById('searching...').style.display = 'none' ;
		data = null;
		table = null;
		query = null;
		document.getElementById('main_div').removeChild(document.getElementById('vis_results'));
		var newDiv = document.createElement("div");
		newDiv.id = "vis_results";
		document.getElementById('main_div').appendChild(newDiv);
    }
	  
	function getFavorites()    {
		UnTip();
		document.getElementById('epsd_div').removeChild(document.getElementById('favorites'));
		var newDiv = document.createElement("div");
		newDiv.id = "favorites";
		document.getElementById('epsd_div').appendChild(newDiv);
		
		var url = 'http://epihourtesting2.appspot.com/getFavorites?uid='+ userID;
		document.getElementById('favorites').style.display = 'none';
		document.getElementById('getting_fav').style.display = '' ;
		document.getElementById('no_fav').style.display = 'none' ;
		alert(url);
		var favoritesQuery = new google.visualization.Query(url);
		//alert("after query");
		// Send the query with a callback function.
		favoritesQuery.send(handleFavoritesQueryResponse);
		//alert("after sending");	
	}
	function handleFavoritesQueryResponse(response)	{
		if (response.isError()) {
			alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
			return;
		}
		var favoritesData = response.getDataTable();
		favoritesData.addColumn('string' , '');
		for (var j=0; j<favoritesData.getNumberOfRows(); j++){
			favoritesData.setValue(j , 11, '<input type="submit" align="center"  class="btn" value="[x]" id="delete'+j+'" onmouseover="this.className=\'btnhov\'" onmouseout="this.className=\'btn\'" onclick="remove_row(\'favoritesData.getValue('+j+',0)\')" />');
		}
		var favoritesTable = new google.visualization.Table(document.getElementById('favorites'));
		var view = new google.visualization.DataView(favoritesData);
		view.hideColumns([0]); // do not show the showID.
		document.getElementById('getting_fav').style.display = 'none' ;
		if (favoritesData.getNumberOfRows() < 1){
			document.getElementById('getting_fav').style.display = 'none' ;
			document.getElementById('no_fav').style.display = '' ;
		}
		else{
			document.getElementById('getting_fav').style.display = 'none' ;
			document.getElementById('favorites').style.display = '';
			favoritesTable.draw(view, {showRowNumber: true, allowHtml:true, page: 'enable', sortColumn:1, page:'enable', width: 210, pageSize: 5});
		}
	}

	function addCallbackFunction(obj) {
		   alert(obj.text);
	};
	
	function makePOSTRequest(url, postdata) {
		var params = {};
		//postdata = gadgets.io.encodeValues(postdata);		// already given in the encodedValue format
		params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
		params[gadgets.io.RequestParameters.POST_DATA]= postdata;
		gadgets.io.makeRequest(url, addCallbackFunction, params); 
	};
	
    function add_show(showId) {
		var url = "http://epihour.appspot.com/addFavorite";
		//creating the shows to add array
		//var showsArray = new Array();
		var body = "uid=" + encodeURIComponent(userID);
		//var j = 0;
		//alert('number of rows:'+data.getNumberOfRows());
		/*for (var i=0; i<data.getNumberOfRows(); i++){ //IF PAGE:'ENABLE' WE NEED TO TO DO I<5!
			//alert('checking row no.'+i);
			if ((document.getElementById('add'+i).checked) == true){
				//alert('true');
				showsArray[j] = data.getValue( i , 0); //getting the showID
				//alert('show no. '+j+':'+showsArray[j]+' was added to the array');
				//var sid = 'sid'+j;
				body += "&sid=" + encodeURIComponent(showsArray[j]);
				//alert(body);
				++j;
			}
		}*/
		body += "&sid=" + encodeURIComponent(showId);
		//body += "&search=" + encodeURIComponent(document.getElementById('srch_txt').value.toLowerCase());
		//alert(body);
		alert("running makePOSTrequest");
		makePOSTRequest(url, body); 
    }

    function add_series(name, s, e){
       var div = document.getElementById('epsd_div');
       mytable = document.getElementById("series");
       mytablebody = document.createElement("tbody")
       mycurrent_row = document.createElement("tr");

               mycurrent_cell = document.createElement("td");
               currenttext = document.createTextNode(name);
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);
               mycurrent_cell = document.createElement("td");
               currenttext = document.createTextNode(s);
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);
               mycurrent_cell = document.createElement("td");
               currenttext = document.createTextNode(e);
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);
                
               mycurrent_cell = document.createElement("td");
               currenttext = document.createElement('input'); 
               currenttext.type = "checkbox";
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);
               
               mycurrent_cell = document.createElement("td");
               currenttext = document.createElement('input'); 
               currenttext.type = "checkbox";
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);

               mycurrent_cell = document.createElement("td");
               currenttext = document.createElement('select');
               newOption = document.createElement("OPTION"); 
               currenttext.options.add(newOption);
               newOption.value = "-";
              newOption.text = "-";
              for(var i=1; i < 6; i++){
               newOption = document.createElement("OPTION"); 
               currenttext.options.add(newOption);
               newOption.value = i
               newOption.text = i;
              }
              mycurrent_cell.appendChild(currenttext);
              mycurrent_row.appendChild(mycurrent_cell);
    
    
               mycurrent_cell = document.createElement("td");
               currenttext = document.createElement('input'); 
               currenttext.type = "button";
               currenttext.value = "[x]";
               currenttext.setAttribute("class","btn");
               currenttext.setAttribute("onmouseover",".btnhov");
               currenttext.setAttribute("onmouseout",".btn");
               mycurrent_cell.appendChild(currenttext);
               mycurrent_row.appendChild(mycurrent_cell);


    
           mytablebody.appendChild(mycurrent_row);
       
       mytable.appendChild(mytablebody);
       div.appendChild(mytable);      
    }
    function remove_row(showId){
		var userID = 11111;
		var answer = confirm("Are you sure you want to delete this show?")
		if (answer){      
			var url = "http://epihour.appspot.com/"; //to change
			var body = "uid=" + encodeURIComponent(userID);
			body += "&sid=" + encodeURIComponent(showId);
			alert(body);
			alert("running makePOSTrequest");
			makePOSTRequest(url, body);
			getFavorites();
		}
    }
     function create_msg()
      {
        var msg = new _IG_MiniMessage(__MODULE_ID__, _gel("news_div"));
        msg.createDismissibleMessage("Heroes S3 E13 is on tonight!", dismissed);   
        msg.createDismissibleMessage("Survivor S17 E13 is on this Tursday !", dismissed);      
      }
    // Used as callback function when message is dismissed.
    // If callback returns false, then cancel the dismissal.
    function dismissed() {
       return confirm("Are you sure you want to discard?");
     }
    function dismiss_epi(line) {
       var answer = confirm("Are you sure you want to discard?")
       if (answer) {
         document.getElementById(line).style.display = 'none'
         document.getElementById(line+'_check').style.display = ''
         document.getElementById(line+'1_check').style.display = ''
       }  
     }
	 
    function chosen(name){ //if we are not using checkboxes, this function can be deleted
     if ((document.getElementById(name).checked)==true){
      ++checked_no;
      //document.getElementById('add_btn').disabled = false
     }
    else{
      --checked_no;
      //if (checked_no ==0)
        //document.getElementById('add_btn').disabled = true
      }
    }
	function getStatistics(type , limit){
		document.getElementById('sts_div').removeChild(document.getElementById('statistics'));
		var newDiv = document.createElement("div");
		newDiv.id = "statistics";
		document.getElementById('sts_div').appendChild(newDiv);
		
		var url = 'http://epihourtesting2.appspot.com/Statistics?type='+type+'&limit='+limit;
		//alert(url);
		var query = new google.visualization.Query(url);
		///alert("after query");
		// Send the query with a callback function.
		if(type == 'shows'){
			query.send(handleShowsStatisticsResponse);
		}
		else{
			query.send(handleGenresStatisticsResponse);			
		}
	}
	function handleShowsStatisticsResponse(response)	{
		if (response.isError()) {
			alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
			return;
		}
		var showsData = response.getDataTable();
		var showsChart = new google.visualization.BarChart(document.getElementById('statistics'));
		showsChart.draw(showsData, {width: 350, height: 190, is3D: true , title:'Most Popular Shows', backgroundColor:'#dbe3eb',focusBorderColor:'#b4c3f6' ,axisColor:'#b4c3f6',legendBackgroundColor:'#b4c3f6'});
	}
	function handleGenresStatisticsResponse(response)	{
		if (response.isError()) {
			alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
			return;
		}
		var genresData = response.getDataTable();
		var genresChart = new google.visualization.PieChart(document.getElementById('statistics'));
		genresChart.draw(genresData, {width: 350, height: 190, is3D: true, title: 'Most Popular Genres', backgroundColor:'#dbe3eb',focusBorderColor:'#b4c3f6',legendBackgroundColor:'#b4c3f6'});
	}
 
      // Call init function to initialize and display tabs.
     
    _IG_RegisterOnloadHandler(init); 
    </script>
</head>
<body bgcolor="#dbe3eb">
<script type="text/javascript" src="http://tvepisodes.googlecode.com/svn/trunk/client/wz_tooltip.js"></script>
    <div id="news_div" class="background" align="center" ></div>

    <div id="epsd_div" class="background" align="center" >
		<br>
		<br>
		<div id="favorites"> </div>
		<div style="display:none" id="getting_fav"> 
			<table id="search_result" class="sample" border="1">
				<tr>
					<th> Getting your favorites, please wait... </th>
				</tr>
			</table>
		</div>
		<div style="display:none" id="no_fav"> 
			<table id="search_result" class="sample" border="1">
				<tr>
					<th> You currently don't have favorites shows. Click "Add" tab to add shows.</th>
				</tr>
			</table>
		</div>
	</div>
    <div class="background" align="center" id="add_div" >
        <br> 
        <table>

          <tr>
            <td> <input type="text" class="txt" value="TV Show Name Here" id="srch_txt" onclick="reset_srch_text()"/> </td>
            <td> <input type="button" class="btn" value="Search" id="srch_btn" onmouseover="this.className='btnhov'"onmouseout="this.className='btn'" onclick="search_episode()" /> </td>
            <td> <input type="button" disabled class="btn" value="Reset" id="reset_srch_btn" onmouseover="this.className='btnhov'"onmouseout="this.className='btn'" onclick="reset_srch()" /></td>
          </tr>

        </table>

        
        <br>
 
      
		<div id="main_div">
			<div id="vis_results"> </div>
			<table id="most_pop" class="sample" border="1"> 
				<tr>
					 <td></td>
					 <th> Most Popular </th>
					 <th> Add </th>
				</tr>
				<tr>
					 <td> 1 </td>
					 <td> Survivor </td>
					 <td> <input style="display:none" type="checkbox" id="survivor_check" onclick="chosen('survivor_check')"/> </td>
				</tr>
				<tr>
					 <td> 2 </td>
					 <td> Heroes </td>
					 <td> <input style="display:none" type="checkbox" id="heroes_check" onclick="chosen('heroes_check')"/> </td>
				</tr>
				<tr>
					 <td> 3 </td>
					 <td> Lost </td>
					 <td> <input style="display:none" type="checkbox" id="lost_check" onclick="chosen('lost_check')"/> </td>
				</tr>
				<tr>
					 <td> 4 </td>
					 <td> Prison Break </td>
					 <td> <input type="checkbox" id="prison_check" onclick="chosen('prison_check')"/> </td>
				</tr>
				<tr>
					 <td> 5 </td>
					 <td> Friends </td>
					 <td> <input type="checkbox" id="friends_check" onclick="chosen('friends_check')"/> </td>
				</tr>
			</table>
		</div>
		<div style="display:none" id="no_result_div"> 
			<table id="search_result" class="sample" border="1">
				<tr>
					<th> No Results. try again! </th>
				</tr>
			</table>
		</div>
		<div style="display:none" id="searching..."> 
			<table id="search_result" class="sample" border="1">
				<tr>
					<th> Searching... </th>
				</tr>
			</table>
		</div>
	</div>
	<div align="center" id="sts_div" class="background">
		<br>
		<select align="center" id="type_selection">
			<option value="genres">Genres</option>
			<option value="shows" >Shows</option>
		</select>
		<select align="center" id="limit_selection">
			<option value="5">5</option>
			<option value="4">4</option>
			<option value="3">3</option>
			<option value="2">2</option>
			<option value="1">1</option>
		</select>
		<input type="button" class="btn" value="See Statistics" id="get_stat" onmouseover="this.className='btnhov'" onmouseout="this.className='btn'" onclick="getStatistics(document.getElementById('type_selection').value.toLowerCase(),document.getElementById('limit_selection').value.toLowerCase())" />
		<br>
		<div align="center" id="statistics"></div>
	</div>
</body>
</html>
    ]]>
  </Content>
</Module>






















































































































































































